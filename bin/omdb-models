#!/usr/bin/env php
<?php

if ($argc !== 3) {
    echo "Usage: omdb-models app/DataModels Project\\\\Namespace" . PHP_EOL;
    exit(1);
}

$targetDir = rtrim($argv[1], '/');
$baseNamespace = trim($argv[2], '\\');

// Point this to wherever your `src/` folder is located relative to this script:
$srcDir = realpath(__DIR__ . '/../src');
if (!$srcDir) {
    echo "Could not find 'src' directory." . PHP_EOL;
    exit(1);
}

/**
 * Recursively copy files from $src to $dst, update namespaces, and rewrite
 * "use Zerotoprod\OmdbModels\..." to "use {baseNamespace}\...".
 *
 * @param string $src          The source path weâ€™re copying from
 * @param string $dst          The destination path
 * @param string $baseNS       The root/base namespace (e.g., "Framework\\DataModels")
 * @param string $relativeNS   The sub-namespace constructed from subfolders
 */
function copy_files(string $src, string $dst, string $baseNS, string $relativeNS = ''): void
{
    $fullNamespace = trim($baseNS . '\\' . $relativeNS, '\\');

    // Ensure the target directory exists
    if (!is_dir($dst)) {
        if (!mkdir($dst, 0777, true) && !is_dir($dst)) {
            throw new RuntimeException(sprintf('Directory "%s" was not created', $dst));
        }
    }

    // Open source directory
    $handle = opendir($src);
    if (!$handle) {
        throw new RuntimeException(sprintf('Directory "%s" could not be opened', $src));
    }

    while (($file = readdir($handle)) !== false) {
        if ($file === '.' || $file === '..') {
            continue;
        }

        $srcFile = $src . '/' . $file;
        $dstFile = $dst . '/' . $file;

        if (is_dir($srcFile)) {
            // Recurse into subdirectory, appending it to the namespace
            copy_files(
                $srcFile,
                $dstFile,
                $baseNS,
                trim($relativeNS . '\\' . $file, '\\')
            );
        } else {
            // Copy file
            copy($srcFile, $dstFile);

            $content = file_get_contents($dstFile);
            if ($content === false) {
                throw new RuntimeException(sprintf('Could not read file "%s"', $dstFile));
            }

            // 1) Replace the file's namespace line
            $content = preg_replace(
                '/^namespace\s+.*;/m',
                'namespace ' . $fullNamespace . ';',
                $content
            );

            // 2) Rewrite "use Zerotoprod\OmdbModels\..." => "use {baseNamespace}\..."
            //    Example: "use Zerotoprod\OmdbModels\SearchItem;" => "use Framework\DataModels\SearchItem;"
            $content = preg_replace(
                '/^use\s+Zerotoprod\\\\OmdbModels\\\\(.+);/m',
                'use ' . trim($baseNS, '\\') . '\\\\$1;',
                $content
            );

            file_put_contents($dstFile, $content);

            echo "Copied file: $dstFile with namespace $fullNamespace" . PHP_EOL;
        }
    }

    closedir($handle);
}

copy_files($srcDir, $targetDir, $baseNamespace);

echo "DONE" . PHP_EOL;